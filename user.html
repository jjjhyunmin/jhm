<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장비 관리 시스템 - 사용자</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        .my-rentals {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>장비 관리 시스템</h1>
            <div class="user-info">
                <span>사용자 모드</span>
                <button class="logout-btn" id="logoutBtn">로그아웃</button>
            </div>
        </div>

        <!-- 장비 목록 표시 -->
        <div class="section">
            <h2>대여 가능한 장비 목록</h2>
            <table id="equipmentTable">
                <thead>
                    <tr>
                        <th>장비명</th>
                        <th>보유 수량</th>
                        <th>대여 가능 수량</th>
                        <th>비고</th>
                        <th>대여</th>
                    </tr>
                </thead>
                <tbody id="equipmentList">
                    <!-- 장비 목록이 여기에 동적으로 추가됩니다 -->
                </tbody>
            </table>
        </div>

        <!-- 나의 대여 현황 -->
        <div class="section my-rentals">
            <h2>장비 대여 기록</h2>
            <table id="myRentalsTable">
                <thead>
                    <tr>
                        <th>장비명</th>
                        <th>대여 기간</th>
                        <th>상태</th>
                        <th>반납 상태</th>
                        <th>비고</th>
                        <th>반납</th>
                    </tr>
                </thead>
                <tbody id="myRentalsList">
                    <!-- 나의 대여 내역이 여기에 동적으로 추가됩니다 -->
                </tbody>
            </table>
        </div>

        <!-- 대여 신청 모달 -->
        <div id="rentalModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>장비 대여 신청</h2>
                <form id="rentalForm">
                    <input type="hidden" id="selectedEquipmentId">
                    <div class="form-group">
                        <label for="rentalQuantity">대여 수량:</label>
                        <input type="number" id="rentalQuantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="startDate">대여 시작일:</label>
                        <input type="date" id="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">반납 예정일:</label>
                        <input type="date" id="endDate" required>
                    </div>
                    <div class="form-group">
                        <label for="userName">이름:</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label for="userDepartment">소속:</label>
                        <input type="text" id="userDepartment" required>
                    </div>
                    <div class="form-group">
                        <label for="userPosition">직급:</label>
                        <input type="text" id="userPosition" required>
                    </div>
                    <div class="form-group">
                        <label for="rentalPassword">대여 비밀번호 (4자리 숫자):</label>
                        <input type="text" id="rentalPassword" maxlength="4" pattern="\d{4}" required>
                    </div>
                    <button type="submit">대여 신청</button>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // 사용자 페이지 전용 스크립트
        document.addEventListener('DOMContentLoaded', () => {
            // 로그아웃 버튼 이벤트 리스너
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('로그아웃 하시겠습니까?')) {
                    window.location.href = 'index.html';
                }
            });
            
            // 사용자 페이지 초기화
            initUserPage();
        });
        
        function initUserPage() {
            // 장비 목록 렌더링
            renderEquipmentList();
            
            // 나의 대여 내역 렌더링
            renderMyRentals();
            
            // 모달 닫기 버튼 이벤트 리스너
            document.querySelector('.close').addEventListener('click', () => {
                document.getElementById('rentalModal').style.display = 'none';
            });
            
            // 모달 외부 클릭 시 닫기
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('rentalModal')) {
                    document.getElementById('rentalModal').style.display = 'none';
                }
            });
            
            // 대여 폼 제출 이벤트 리스너
            document.getElementById('rentalForm').addEventListener('submit', handleRental);
            
            // 오늘 날짜 이후만 선택 가능하도록 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('endDate').min = tomorrow.toISOString().split('T')[0];
        }
        
        function renderMyRentals() {
            const myRentalsList = document.getElementById('myRentalsList');
            const rentals = JSON.parse(localStorage.getItem('rentals')) || [];
            const equipments = JSON.parse(localStorage.getItem('equipments')) || [];
            
            // 현재 프로젝트에서는 실제 로그인 사용자 정보와의 연동이 없으므로
            // 모든 대여 내역을 사용자 페이지에서 조회할 수 있도록 한다.
            const myRentals = rentals;
            
            myRentalsList.innerHTML = '';
            
            if (myRentals.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">대여 내역이 없습니다.</td>';
                myRentalsList.appendChild(row);
                return;
            }
            
            myRentals.forEach(rental => {
                const equipment = equipments.find(e => e.id === rental.equipmentId);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${equipment ? equipment.name : '알 수 없음'}</td>
                    <td>${rental.startDate} ~ ${rental.endDate}</td>
                    <td>${getRentalStatusText(rental.status)}</td>
                    <td>${rental.status === 'rejected' ? '거절됨' : (rental.returned ? '반납완료' : '대여중')}</td>
                    <td>${rental.status === 'rejected' && rental.rejectReason ? '거절: ' + rental.rejectReason : (rental.damaged ? '파손: ' + (rental.damageNote || '파손 내용 없음') : '-')}</td>
                    <td>${!rental.returned && rental.status === 'approved' ? `<button class="user-return-btn" data-id="${rental.id}">반납</button>` : '-'}</td>
                `;
                
                myRentalsList.appendChild(row);
            });

            // 사용자 반납 버튼 클릭 처리
            myRentalsList.addEventListener('click', handleUserReturn);
        }
        
        function getRentalStatusText(status) {
            const statusMap = {
                'pending': '대기중',
                'approved': '승인됨',
                'rejected': '거절됨',
                'returned': '반납완료'
            };
            return statusMap[status] || status;
        }

        function handleUserReturn(e) {
            const target = e.target;
            if (!target.classList.contains('user-return-btn')) return;

            const rentalId = target.getAttribute('data-id');
            const rentals = JSON.parse(localStorage.getItem('rentals')) || [];
            const rentalIndex = rentals.findIndex(r => r.id === rentalId);
            if (rentalIndex === -1) return;

            const inputPassword = prompt('대여 시 설정한 4자리 비밀번호를 입력해주세요:');
            if (inputPassword === null) return;

            if (rentals[rentalIndex].password !== inputPassword) {
                alert('비밀번호가 일치하지 않습니다.');
                return;
            }

            const rental = rentals[rentalIndex];

            // 파손 여부 확인
            const isDamaged = confirm('장비가 파손되었나요?');

            rental.returned = true;
            rental.returnedDate = new Date().toISOString().split('T')[0];
            rental.status = 'returned';
            rental.damaged = isDamaged;

            if (isDamaged) {
                const damageNote = prompt('파손 내용을 입력해주세요:');
                rental.damageNote = damageNote || '파손 내용 없음';
            }

            localStorage.setItem('rentals', JSON.stringify(rentals));

            // 반납 후 화면 새로고침
            alert('반납이 완료되었습니다.');
            location.reload();
        }
    </script>
</body>
</html>
